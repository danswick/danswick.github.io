<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapventure!</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.15.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox.js/plugins/turf/v2.0.2/turf.min.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        #choice { position: absolute; top: 1em; left: 1em; padding: 0.5em; background-color: #fff; }
        #target { 
            width: 15px;
            height: 15px;
            position: fixed;
            border-radius: 10px;
            border: 2px solid #fff;
            box-shadow: 0px 0px 7px -2px rgba(0, 0, 0, 0.5);
            background-color: transparent;
            top: 50%;
            left: 50%;
        }
    </style>
</head>
<body>

<div id='map'></div>
<div id='target'></div>
<!-- <div id="choice">PICK</div> -->
<script>

// Map setup
var zoomSetting = 16.2;
var bboxS = 37.8185,
    bboxN = 37.84764,
    bboxE = -122.467,
    bboxW = -122.5488;

mapboxgl.accessToken = 'pk.eyJ1IjoiZGFuc3dpY2siLCJhIjoieUZiWmwtVSJ9.0cPQywdbPVmvHiHJ6NwdXA';
var map = new mapboxgl.Map({
    container: 'map', 
    style: 'mapbox://styles/danswick/cilnegnzr00439gkf7urxz0xk', 
    minZoom: zoomSetting,
    maxZoom: zoomSetting,
    maxBounds: [[bboxE, bboxN], [bboxW, bboxS]],
    center: [-122.55, 37.84], 
    zoom: zoomSetting 
});


// Hex setup 
var bbox = [bboxE, bboxN, bboxW, bboxS];
var cellWidth = 0.15;
var units = 'miles';
var grid = turf.hexGrid(bbox, cellWidth, units);

// Add unique IDs and a property to store info 
// on whether we've visitied each hex
for(i = 0; i < grid.features.length; i++) {
    grid.features[i].properties.idNum = i;
    grid.features[i].properties.visited = 'no';
}

// Great a new GeoJSON source from our hex geojson
var source = new mapboxgl.GeoJSONSource({
    data: grid
});

map.on('style.load', function () {
    // Add hex source to the map
    map.addSource('hexgrid', source);

    /* Set up a few layers: 
     *   - 2 hex outlines to make them look spooky
     *   - The un-visited hexes, {visited} = 'no' 
     *   - Visited hexes, {visited} == 'yes'
     */
    map.addLayer({
        'id': 'hexgrid-line-2',
        'type': 'line',
        'source': 'hexgrid',
        'layout': {
            'line-join': 'round'
        },
        'paint': {
            'line-color': '#333',
            'line-opacity': 0.8,
            'line-width': 50,
            'line-blur': 60,
        },
        'filter': ['==', 'visited', 'no']
    });
    map.addLayer({
        'id': 'hexgrid-line',
        'type': 'line',
        'source': 'hexgrid',
        'layout': {
            'line-join': 'round'
        },
        'paint': {
            'line-color': '#333',
            'line-opacity': 0.8,
            'line-width': 30,
            'line-blur': 30,
        },
        'filter': ['==', 'visited', 'no']
    });
    var hexGridLayer = map.addLayer({
        'id': 'hexgrid',
        'interactive': true,
        'type': 'fill',
        'source': 'hexgrid',
        'layout': {},
        'paint': {
            'fill-color': '#222',
            'fill-opacity': 1
        },
        'filter': ['==', 'visited', 'no']
    });
    map.addLayer({
        'id': 'hexgrid-visited',
        'type': 'fill',
        'source': 'hexgrid',
        'layout': {},
        'paint': {
            'fill-color': '#fff',
            'fill-outline-color': '#777',
            'fill-opacity': 0
        },
        'filter': ['==', 'visited', 'yes']
    });
});

// Whenever the map is moving, check to see if we've 
// visited the hex under the center coord
map.on('move', function(e) {
    map.featuresAt(map.project(map.getCenter()), {layer: 'hexgrid', radius: 1, includeGeometry: true}, function (err, features) {
        if (err) throw err;
        visitMe(features[0].properties.idNum);
    });
});

// When we're done moving, update the hex source's data
// note: this is not ideal, but updating source data
// continually is much worse! 
map.on('moveend', function(e){
    source.setData(grid);
});

// Update the hex under the center coord's visited property!
function visitMe(featureId) {
    grid.features[featureId].properties.visited = 'yes';
}




/* potential future choose-your-own-adventure stuff for later 
 * ==========================================================

 var gameLocations = [
    {
        "name": "Home",
        "coordinates": [-122.261, 37.837]
    },
    {
        "name": "The mountain",
        "coordinates": [-121.915, 37.882]
    },
    {
        "name": "The marshland",
        "coordinates": [-122.089, 37.5566]
    }
];

var picky = document.getElementById('choice');
picky.onclick = function(e) {
    var target = $(e.target).parent();
    var coords = $(target).data(coords);
    var myCoords = JSON.parse("[" + coords.coords + "]");
    nextPosition(myCoords);
}
for (i=0; i < gameLocations.length; i++) {
    $('#choice').append("<div class='choice-item' data-coords='" + gameLocations[i].coordinates + "'><span class='choice-name'>" + gameLocations[i].name) + "</span>"
}

function nextPosition(endLocation) {
    map.panTo(endLocation, {duration: 5000});
}
* =============================================================
* /
</script>
</body>
</html>